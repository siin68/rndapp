datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Core User Model
model User {
  id                Int                  @id @default(autoincrement())
  name              String
  email             String               @unique
  emailVerified     DateTime?
  image             String?
  bio               String?
  age               Int?
  gender            String?            // MALE, FEMALE, OTHER
  phoneNumber       String?
  isActive          Boolean              @default(true)
  isVerified        Boolean              @default(false)
  onboardingCompleted Boolean            @default(false)
  lastActive        DateTime             @default(now())
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  
  // Profile settings
  profileVisibility String               @default("PUBLIC") // PUBLIC, FRIENDS_ONLY, PRIVATE
  distanceRadius    Int                  @default(10) // km
  ageRangeMin       Int                  @default(18)
  ageRangeMax       Int                  @default(50)
  
  // Relations
  hobbies           UserHobby[]
  locations         UserLocation[]
  hostedEvents      Event[]              @relation("HostEvents")
  eventParticipants EventParticipant[]
  eventJoinRequests EventJoinRequest[]
  sentInvitations   EventInvitation[]    @relation("SentInvitations")
  receivedInvitations EventInvitation[]  @relation("ReceivedInvitations")
  chatParticipants  ChatParticipant[]
  sentMessages      Message[]            @relation("SenderMessages")
  sentFriendRequests FriendRequest[]     @relation("SenderFriendRequests")
  receivedFriendRequests FriendRequest[] @relation("ReceiverFriendRequests")
  friendships1      Friendship[]         @relation("User1Friendships")
  friendships2      Friendship[]         @relation("User2Friendships")
  sentSwipes        Swipe[]              @relation("UserSwipes")
  receivedSwipes    Swipe[]              @relation("ReceivedSwipes")
  sentReviews       Review[]             @relation("ReviewSender")
  receivedReviews   Review[]             @relation("ReviewReceiver")
  notifications     Notification[]
  reportsMade       Report[]             @relation("ReportSender")
  reportsReceived   Report[]             @relation("ReportReceiver")
  blockedUsers      BlockedUser[]        @relation("BlockerUsers")
  blockedByUsers    BlockedUser[]        @relation("BlockedUsers")
}

// Hobby System
model Hobby {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  nameVi      String
  category    String
  icon        String
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  
  // Relations
  users       UserHobby[]
  events      EventHobby[] // Many-to-many relation with events
}

model UserHobby {
  id          Int      @id @default(autoincrement())
  userId      Int
  hobbyId     Int
  skillLevel  String   @default("BEGINNER") // BEGINNER, INTERMEDIATE, ADVANCED, EXPERT
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hobby       Hobby    @relation(fields: [hobbyId], references: [id], onDelete: Cascade)
  
  @@unique([userId, hobbyId])
}

// Location System
model City {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  nameVi      String
  country     String     @default("Vietnam")
  timezone    String     @default("Asia/Ho_Chi_Minh")
  isActive    Boolean    @default(true)
  
  locations   Location[]
}

model Location {
  id          Int            @id @default(autoincrement())
  name        String
  nameVi      String
  cityId      Int
  address     String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean        @default(true)
  
  city        City           @relation(fields: [cityId], references: [id])
  users       UserLocation[]
  events      Event[]
}

model UserLocation {
  id        Int      @id @default(autoincrement())
  userId    Int
  locationId Int
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location  Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  @@unique([userId, locationId])
}

// Event System
model Event {
  id               Int                @id @default(autoincrement())
  title            String
  description      String?
  image            String?            // Event cover image URL
  hostId           Int
  locationId       Int
  date             DateTime
  duration         Int?               // minutes
  maxParticipants  Int                @default(10)
  minParticipants  Int                @default(2)
  price            Float?             @default(0)
  currency         String             @default("VND")
  status           String             @default("OPEN") // DRAFT, OPEN, FULL, ONGOING, COMPLETED, CANCELLED
  isPrivate        Boolean            @default(false)
  requiresApproval Boolean            @default(false)
  ageRestrictionMin Int?
  ageRestrictionMax Int?
  genderRestriction String?            // MALE, FEMALE, OTHER
  tags             String?            // JSON array of tags
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  
  host             User               @relation(fields: [hostId], references: [id], name: "HostEvents")
  location         Location           @relation(fields: [locationId], references: [id])
  hobbies          EventHobby[]       // Many-to-many relation with hobbies
  participants     EventParticipant[]
  joinRequests     EventJoinRequest[]
  invitations      EventInvitation[]
  chats            Chat[]
  reviews          Review[]
  notifications    Notification[]
}

// Junction table for Event-Hobby many-to-many relation
model EventHobby {
  id        Int      @id @default(autoincrement())
  eventId   Int
  hobbyId   Int
  isPrimary Boolean  @default(false) // Primary hobby for the event
  createdAt DateTime @default(now())
  
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  hobby     Hobby    @relation(fields: [hobbyId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, hobbyId])
}

model EventParticipant {
  id         Int                 @id @default(autoincrement())
  eventId    Int
  userId     Int
  status     String              @default("JOINED") // JOINED, LEFT, KICKED, BANNED
  joinedAt   DateTime            @default(now())
  leftAt     DateTime?
  
  event      Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
}

model EventJoinRequest {
  id        Int      @id @default(autoincrement())
  eventId   Int
  userId    Int
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  message   String?  // Optional message from user
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
}

model EventInvitation {
  id        Int              @id @default(autoincrement())
  eventId   Int
  fromUserId Int
  toUserId  Int
  status    String           @default("PENDING") // PENDING, ACCEPTED, DECLINED, CANCELLED
  message   String?
  sentAt    DateTime         @default(now())
  respondedAt DateTime?
  
  event     Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  fromUser  User             @relation(fields: [fromUserId], references: [id], name: "SentInvitations", onDelete: Cascade)
  toUser    User             @relation(fields: [toUserId], references: [id], name: "ReceivedInvitations", onDelete: Cascade)
  
  @@unique([eventId, fromUserId, toUserId])
}

// Chat System
model Chat {
  id           Int               @id @default(autoincrement())
  eventId      Int?
  type         String            @default("GROUP") // DIRECT, GROUP, EVENT
  name         String?
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  event        Event?            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participants ChatParticipant[]
  messages     Message[]
}

model ChatParticipant {
  id          Int       @id @default(autoincrement())
  chatId      Int
  userId      Int
  role        String    @default("MEMBER") // OWNER, ADMIN, MEMBER
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?
  lastReadAt  DateTime  @default(now())
  
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([chatId, userId])
}

model Message {
  id          Int         @id @default(autoincrement())
  chatId      Int
  senderId    Int
  content     String
  type        String      @default("TEXT") // TEXT, IMAGE, FILE, SYSTEM
  attachments String?     // JSON array of attachment URLs
  replyToId   Int?
  isEdited    Boolean     @default(false)
  timestamp   DateTime    @default(now())
  editedAt    DateTime?
  
  chat        Chat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender      User        @relation(fields: [senderId], references: [id], name: "SenderMessages")
  replyTo     Message?    @relation("MessageReply", fields: [replyToId], references: [id])
  replies     Message[]   @relation("MessageReply")
}

// Social Features
model Swipe {
  id        Int       @id @default(autoincrement())
  userId    Int
  targetId  Int
  action    String    // LIKE, NOPE
  createdAt DateTime  @default(now())
  expiresAt DateTime? // Only for NOPE actions - expires after 1 week
  
  user      User      @relation("UserSwipes", fields: [userId], references: [id], onDelete: Cascade)
  target    User      @relation("ReceivedSwipes", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@unique([userId, targetId])
  @@index([expiresAt])
}

model FriendRequest {
  id          Int                 @id @default(autoincrement())
  senderId    Int
  receiverId  Int
  status      String              @default("PENDING") // PENDING, ACCEPTED, DECLINED, CANCELLED
  message     String?
  sentAt      DateTime            @default(now())
  respondedAt DateTime?
  
  sender      User                @relation(fields: [senderId], references: [id], name: "SenderFriendRequests", onDelete: Cascade)
  receiver    User                @relation(fields: [receiverId], references: [id], name: "ReceiverFriendRequests", onDelete: Cascade)
  
  @@unique([senderId, receiverId])
}

model Friendship {
  id        Int      @id @default(autoincrement())
  user1Id   Int
  user2Id   Int
  createdAt DateTime @default(now())
  
  user1     User     @relation(fields: [user1Id], references: [id], name: "User1Friendships", onDelete: Cascade)
  user2     User     @relation(fields: [user2Id], references: [id], name: "User2Friendships", onDelete: Cascade)
  
  @@unique([user1Id, user2Id])
}

model BlockedUser {
  id        Int      @id @default(autoincrement())
  blockerId Int
  blockedId Int
  reason    String?
  createdAt DateTime @default(now())
  
  blocker   User     @relation(fields: [blockerId], references: [id], name: "BlockerUsers", onDelete: Cascade)
  blocked   User     @relation(fields: [blockedId], references: [id], name: "BlockedUsers", onDelete: Cascade)
  
  @@unique([blockerId, blockedId])
}

// Rating & Review System
model Review {
  id          Int        @id @default(autoincrement())
  eventId     Int
  reviewerId  Int
  revieweeId  Int
  rating      Float      // 1.0 to 5.0
  comment     String?
  tags        String?    // JSON array of review tags
  createdAt   DateTime   @default(now())
  
  event       Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  reviewer    User       @relation(fields: [reviewerId], references: [id], name: "ReviewSender", onDelete: Cascade)
  reviewee    User       @relation(fields: [revieweeId], references: [id], name: "ReviewReceiver", onDelete: Cascade)
  
  @@unique([eventId, reviewerId, revieweeId])
}

// Notification System
model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      String           // FRIEND_REQUEST, EVENT_INVITATION, EVENT_REMINDER, NEW_MESSAGE, EVENT_UPDATE, SYSTEM, EVENT_INVITE, EVENT_ACCEPTED, EVENT_REJECTED, EVENT_JOIN_REQUEST
  title     String?
  message   String
  data      String?          // JSON data for notification
  eventId   Int?             // Optional event reference
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event?           @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

// Report & Moderation System
model Report {
  id          Int          @id @default(autoincrement())
  reporterId  Int
  reportedId  Int
  type        String       // SPAM, HARASSMENT, INAPPROPRIATE_CONTENT, FAKE_PROFILE, OTHER
  reason      String
  description String?
  status      String       @default("PENDING") // PENDING, REVIEWING, RESOLVED, DISMISSED
  createdAt   DateTime     @default(now())
  resolvedAt  DateTime?
  
  reporter    User         @relation(fields: [reporterId], references: [id], name: "ReportSender", onDelete: Cascade)
  reported    User         @relation(fields: [reportedId], references: [id], name: "ReportReceiver", onDelete: Cascade)
}

